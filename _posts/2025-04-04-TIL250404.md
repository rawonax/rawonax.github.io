---
title: "250404TIL-Webhook Signature 검증 실패? 로컬에선 안 터지던 그놈"
categories: [TIL]

date: 2025-04-03
---


# 🖕🏻TIL – Webhook Signature 검증 실패? 로컬에선 안 터지던 그놈
 > 오늘의 삽질 요약: Stripe webhook signature 검증이 운영 서버에서만 간헐적으로 실패한다.

## 👾 문제 상황
결제 시스템을 붙이는 도중 Stripe Webhook에서 이런 에러가 간헐적으로 터짐:

```
⚠️ Error: No signatures found matching the expected signature for payload.
```
처음엔 딱 봐도 뭔가 `header` 문제거나 `secret` 키 잘못 쓴 건가 싶었음.
근데 다시 봐도 다 맞다.

- 시크릿 키도 올바름 (?)
- 헤더도 잘 옴 (?)
- body도 있음 (?)
- 로컬에선 webhook signature 잘 검증됨 (?)

👉 운영 서버에서만 간헐적으로 실패.

![정신차려리오레이비](https://i.ytimg.com/vi/r89xSf4PkFw/maxresdefault.jpg)


## 🧠 의심 리스트

### 1. nginx proxy가 뭔가 body를 꼬았나?

#### 금쪽이는 왜 그런 생각을 했을까?  

Webhook signature 오류는 대부분 body가 변조되었을 때 발생한다. 로컬에선 잘 되는데 운영에서만 깨진다면, Nginx가 proxy 역할을 하면서 request body를 건드렸을 가능성이 있다.

**가능한 시나리오**

- Content-Encoding을 자동으로 바꾸거나 생략
- Transfer-Encoding: chunked 같은 걸로 인코딩 방식이 바뀌었는데 backend에서 제대로 처리 못함
- body가 stream 형태로 오는데, 중간에서 한 번 파싱되고 재가공되며 깨짐

**확인 포인트**

- `Nginx config`에서 `proxy_pass`와 관련된 `proxy_set_header`, `client_body_buffer_size`, `proxy_request_buffering` 같은 설정 확인해보기 

- `Webhook endpoint`로 들어온 요청을 `tcpdump`, `mitmproxy`, 또는 `nginx access log + error log`로 `raw`로 덤프해보기

> 가능하면 `nginx` 없이 직접 도는 포트로 테스트해서 비교

### 2. Cloudflare가 이상한 걸 건드렸나?

3. 서버 시간이 Stripe랑 미세하게 다르나?

4. 한글 인코딩이 문제인가? 

정신이 혼미해지기 시작함…

🔬 삽질 1: body-parser + JSON.parse()
문제의 원인은 진짜 은근하고도 치명적인 부분에 있었다.

Webhook에서 signature를 검증하려면, "원본 body 그대로" 사용해야 하는데
나는 평소처럼 아래처럼 처리하고 있었음:

js
복사
편집
app.use(express.json()); // 모든 라우터에 공통 사용
이러면 req.body는 파싱된 JSON 객체가 되는데,
Stripe는 raw body 기준으로 HMAC을 생성하기 때문에 signature mismatch가 발생함.

✅ 해결책: body-parser를 쓰지 말고 raw로 읽기

js
복사
편집
app.post('/webhook', express.raw({ type: 'application/json' }), (req, res) => {
  const sig = req.headers['stripe-signature'];
  const event = stripe.webhooks.constructEvent(req.body, sig, STRIPE_WEBHOOK_SECRET);
  ...
});
이걸로 일단 signature mismatch는 해결됨.

⚠️ 그리고 또 다른 함정: req.body가 Buffer다
이제 검증은 통과되는데, 이전처럼 req.body.id 같은 거 쓰던 코드에서 오류가 발생함.

bash
복사
편집
TypeError: Cannot read property 'id' of undefined
그럴 수밖에. 이제 req.body는 JSON 객체가 아니라 버퍼(Buffer) 상태니까.
signature 검증 후엔 꼭 JSON으로 다시 파싱해서 써야 함:

js
복사
편집
const event = stripe.webhooks.constructEvent(req.body, sig, STRIPE_WEBHOOK_SECRET);
const data = event.data.object; // 이제 제대로 접근 가능
🤯 그런데 왜 로컬에선 멀쩡했을까?
이게 진짜 사람 피말리게 하는 포인트.

로컬에서 stripe-cli로 테스트할 땐 문제가 안 생긴다.
왜냐면 stripe-cli는 단순히 빠르게 쏴주는 거고, 테스트 이벤트라서 간섭받을 게 없음.

운영에서는:

Cloudflare, Nginx, 로드밸런서가 중간에 있음

TLS 종료나 헤더 압축 등도 변수

일부 요청만 깨지니까 간헐적으로 발생해서 혼란 유발

🧩 오늘의 교훈
webhook 처리 라우트는 절대 express.json()이나 body-parser.json() 쓰면 안 됨

반드시 express.raw()로 읽어야 한다

받은 req.body는 Buffer이고, signature 검증 후에 JSON.parse()하거나 event.data.object로만 접근

📌 다음 편 예고:

결국 이 방식도 완벽하지 않았다...
운영 중 webhook 이벤트 일부가 여전히 실패하는 경우가 존재했다.
다음 편에서는 clock drift와 한글 인코딩 이슈까지 파헤쳐본다.

🧵 Part 2에서 계속...

