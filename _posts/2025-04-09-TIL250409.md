---
title: "TIL-외부 API 호출 실패와 연결 문제를 풀어내기"
categories: [til,frontend]

date: 2025-04-07
---

# 🖕🏻TIL – 외부 API 호출 실패와 연결 문제를 풀어낸 그날
> 오늘의 삽질 요약: 외부 API 호출이 실패하는 이유를 파헤쳐가며, 네트워크 문제와 서버 설정을 점검한 끝에 결국 문제를 해결했다.

## 👾 문제 상황
최근 진행 중인 외주 프로젝트에서, **서드파티 API**를 호출해야 하는 기능이 있었다. API 자체는 잘 만들어져 있어서 문서대로만 하면 되겠지 했는데, 호출을 해도 응답이 오지 않아서 도대체 이 간단한 문제를 왜 해결을 못하는건지 고민하다가도 원래 하던대로 했을때 안되는 걸 보면서 뭔가 문제가 있구나 생각했다.
![세상이나한테이런시련을](https://blog.kakaocdn.net/dn/1blLM/btsCVIHdsUe/GYiN3sy8pTEUWh2LA1cGU1/img.jpg)

 더군다나 다른 사람들은 잘 되는데 내 서버에서만 계속 실패하는 상황이었다. 로컬에서는 잘 되던 API 호출이 운영 서버에서만 자꾸 **`Timeout`** 오류가 나는 걸 보며 고민을 시작했다.

### 에러 메시지
```
Error: Request failed with status code 408
```

- **로컬에서 잘 된다**
- **운영 서버에서는만 자꾸 타임아웃**
- **다른 팀은 잘 되는데 내 서버만 문제**

도대체 뭐가 문제일까? API 서버는 이상이 없는 것 같고, 요청도 제대로 가고 있는 것 같은데… 뭔가 서버 환경에서 문제가 발생하는 듯했다. 

## 🔍 트러블슈팅 1: 네트워크 문제 의심
우선 `Timeout` 오류가 발생하는 경우, 네트워크 문제가 의심됐다. 특히 **서버 간 연결**이나 **방화벽** 설정에서 문제가 있을 수 있기 때문에, 서버와 외부 API 서버 간의 연결 상태를 점검해야 했다.

### 해결 방법:
1. **Ping 테스트**: 운영 서버에서 외부 API 서버에 핑을 날려서 연결이 제대로 되는지 확인했다.
   ```bash
   ping api.external-service.com
   ```
   여기서 **응답이 없다면** 네트워크 자체에 문제가 있을 수 있다.

2. **Port Test**: 외부 API의 **특정 포트**가 열려 있는지 확인해봤다. 때때로 API 호출이 특정 포트를 통해 이루어지기 때문에 해당 포트가 차단되었을 가능성도 있었다.
   ```bash
   nc -zv api.external-service.com 443
   ```
   하지만 **포트는 열려 있었다**. 네트워크 연결에는 문제가 없었다.

### 결과:
네트워크가 정상적으로 연결되는 걸 확인했다. 그럼 다른 원인을 찾아봐야 했다.

## 🔍 트러블슈팅 2: 서버 리소스 부족
API 호출이 타임아웃되는 이유로 **서버 리소스 부족**도 의심됐다. 운영 서버에서만 발생하는 문제이므로, 서버 자원(CPU, 메모리, 네트워크 대역폭 등)의 부족이 문제일 가능성도 있었다.

### 해결 방법:
1. **서버 자원 확인**: 서버의 **CPU 사용량**과 **메모리 사용량**을 확인해봤다.
   ```bash
   top
   free -m
   ```
   이 시점에서 **CPU 사용량**과 **메모리 사용량** 모두 정상이었다. 그렇다면 서버 리소스 문제는 아닌 듯했다.

2. **네트워크 대역폭 확인**: 너무 많은 요청을 처리하다 보니 네트워크 대역폭이 부족해져서 타임아웃이 발생했을 수도 있다. 이를 점검하기 위해 `iftop`을 사용해 트래픽을 확인했다.
   ```bash
   sudo iftop -ni eth0
   ```
   다행히도 **트래픽도 정상**이었다.

### 결과:
리소스 부족은 원인이 아니었다. 서버 자원은 충분히 여유가 있었고, 네트워크 대역폭도 문제없었다.

## 🔍 트러블슈팅 3: API 서버의 제한
API 호출을 다루는 서버에는 일정량 이상의 요청을 한꺼번에 처리할 수 없는 경우가 있다. 이러한 **API rate limit**이 걸려있을 수도 있었다. 다른 사람들은 잘 된다고 했지만, 내 서버에서만 계속 문제가 생긴다면 API 서버가 **내 IP**를 제한했을 가능성도 있었다.

### 해결 방법:
1. **API 문서 확인**: API 제공자가 제공하는 문서를 다시 꼼꼼히 읽어봤다. `Rate Limit` 설정이 명시되어 있었고, 이를 초과하면 일정 시간 동안 요청을 제한한다고 적혀 있었다.
2. **헤더 분석**: API 응답 헤더에 `X-RateLimit-Remaining` 같은 정보가 포함되어 있는지 확인했다.
   ```js
   const axios = require('axios');

   axios.get('https://api.external-service.com/data')
     .then(response => {
       console.log(response.headers);
     })
     .catch(error => {
       console.error(error);
     });
   ```
   응답 헤더에 `X-RateLimit-Remaining` 값이 있었고, 이를 통해 **남은 호출 횟수**를 확인할 수 있었다. 내 서버에서 호출을 너무 많이 했던 것이다.

### 해결 방법:
1. **Rate Limit 초과 문제 해결**: API 호출 간에 일정 시간을 두고 요청을 보내거나, **백오프(backoff)** 전략을 적용해서 요청을 제한했다.
2. **IP 화이트리스트**: API 서버에서 내 서버 IP가 **BlackList**에 올라간 게 아닌지 확인해봤다. API 제공자에게 문의한 결과, 내 IP가 일시적으로 제한된 것을 확인할 수 있었다. 요청을 통해 제한을 해제받았다.

## 🔍 트러블슈팅 4: 클라이언트 라이브러리 문제
혹시나 했지만, 사용하는 **클라이언트 라이브러리**에도 문제가 있을 수 있었다. `axios` 또는 `fetch`와 같은 HTTP 클라이언트를 사용할 때, **타임아웃 설정**을 제대로 하지 않으면 기본값으로 설정된 타임아웃 시간이 짧아서, 대용량의 데이터를 받아오는 과정에서 타임아웃이 발생할 수 있다.

### 해결 방법:
1. **타임아웃 시간 늘리기**: `axios`에서 타임아웃 시간을 늘려보았다.
   ```js
   const axios = require('axios');

   axios.get('https://api.external-service.com/data', { timeout: 10000 })
     .then(response => console.log(response.data))
     .catch(error => console.error(error));
   ```

### 결과:
이 방식으로 타임아웃 오류를 해결할 수 있었다. 이제는 API 호출이 정상적으로 완료되었다.

## 🍃 오늘의 교훈
- **네트워크 연결**을 확인할 때는 핑, 포트 체크, 그리고 `curl`을 사용해 API 서버와의 연결 상태를 점검해야 한다.
- 서버 자원은 항상 모니터링하고, 특히 **CPU**와 **메모리** 사용량을 체크해야 한다.
- **Rate limit**을 초과하지 않도록 호출을 조절해야 하며, 필요하면 **백오프(backoff)** 전략을 적용해야 한다.
- **타임아웃 설정**은 기본값이 짧을 수 있으므로, HTTP 클라이언트에서 타임아웃 시간을 늘려야 한다.

오늘은 외부 API 연결 문제를 해결하면서, 서버 환경과 네트워크 설정을 철저히 점검한 덕분에 원인을 찾을 수 있었다. 결국엔 서버와 클라이언트의 작은 설정 차이가 문제를 일으켰던 셈인데, 이런 세밀한 부분까지 체크해야 한다는 걸 다시 한번 깨달았다.
